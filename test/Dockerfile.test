# Dockerfile.test
FROM node:18-bullseye

# Ù†ØµØ¨ Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² ØªØ³Øªâ€ŒÙ‡Ø§
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    docker.io \
    netcat \
    iputils-ping \
    jq && \
    rm -rf /var/lib/apt/lists/*

# Ø³Øª Ú©Ø±Ø¯Ù† Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒ Ú©Ø§Ø±
WORKDIR /app

# Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† start script
RUN echo '#!/bin/bash\n\
    set -e\n\
    echo "ðŸ“¦ Installing dependencies..."\n\
    cd /app\n\
    \n\
    # Ù†ØµØ¨ dependencies chaincode\n\
    if [ -d "chaincode" ] && [ -f "chaincode/package.json" ]; then\n\
    echo "Installing chaincode dependencies..."\n\
    npm install --prefix chaincode --no-audit --no-fund\n\
    fi\n\
    \n\
    # Ù†ØµØ¨ dependencies ØªØ³Øª - Ù…Ø³ÛŒØ± Ø¯Ø±Ø³Øª\n\
    if [ -d "test" ] && [ -f "test/package.json" ]; then\n\
    echo "Installing test dependencies..."\n\
    npm install --prefix test --no-audit --no-fund\n\
    fi\n\
    \n\
    # Ù†ØµØ¨ dependencies Ø§ØµÙ„ÛŒ Ø§Ú¯Ø± package.json ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯\n\
    if [ -f "package.json" ]; then\n\
    echo "Installing main dependencies..."\n\
    npm install --no-audit --no-fund\n\
    fi\n\
    \n\
    echo "â³ Waiting for network and chaincode deployment..."\n\
    sleep 45\n\
    \n\
    echo "ðŸ§ª Running tests..."\n\
    # Ú†Ú© Ú©Ù† Ú©Ù‡ Ú©Ø¯Ø§Ù… package.json Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª Ùˆ Ø§Ø² Ø¢Ù† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†\n\
    if [ -f "test/package.json" ]; then\n\
    echo "Running tests from test directory..."\n\
    cd test && npm test\n\
    elif [ -f "package.json" ]; then\n\
    echo "Running tests from main directory..."\n\
    npm test\n\
    else\n\
    echo "âŒ No package.json found for tests!"\n\
    exit 1\n\
    fi\n\
    echo "âœ… Tests completed!"\n' > /start.sh && \
    chmod +x /start.sh

# Default command
CMD ["/start.sh"]
